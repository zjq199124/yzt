<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maizhiyu.yzt.mapper.BuPrescriptionMapper">


    <select id="selectPrescriptionItemSummary" resultType="hashmap">
        select
            A.entity_id, A.name entity_name, A.quantity, X.used
        from
            (
                select *
                from bu_prescription_item
                where prescription_id = #{prescriptionId}
            ) A
                left join
            (
                select item_id, count(*) used
                from bu_treatment
                where prescription_id = #{prescriptionId}
                group by item_id
            ) X
            on A.id = X.item_id
    </select>

    <!-- type = 4、5 时表示协定方（熏蒸方）和治疗方-->
    <select id="selectPatientPrescriptionItemSummary" resultType="hashmap">
        select
            P.doctor_id, P.code,
            DATE_FORMAT(P.create_time, '%Y-%m-%d %T') create_time,
            A.prescription_id, A.id item_id, A.type, A.entity_id, A.name entity_name, A.detail, A.quantity,
            X.used
        from
            (
                select *
                from bu_prescription
                where type = 5
            ) P
            join
            (
                select *
                from bu_prescription_item
                where patient_id = #{patientId}
            ) A on P.id = A.prescription_id
            left join
            (
                select item_id, count(*) used
                from bu_treatment
                where patient_id = #{patientId}
                group by item_id
            ) X on A.id = X.item_id
    </select>

</mapper>

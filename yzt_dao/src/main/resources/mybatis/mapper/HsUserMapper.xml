<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maizhiyu.yzt.mapper.HsUserMapper">

    <resultMap id="UserMap" type="com.maizhiyu.yzt.entity.HsUser">
        <result property="id" column="id" jdbcType="BIGINT"/>
        <result property="customerId" column="customer_id" jdbcType="BIGINT"/>
        <result property="status" column="status" jdbcType="INTEGER"/>
        <result property="username" column="username" jdbcType="VARCHAR"/>
        <result property="password" column="password" jdbcType="VARCHAR"/>
        <result property="nickname" column="nickname" jdbcType="VARCHAR"/>
        <result property="realname" column="realname" jdbcType="VARCHAR"/>
        <result property="phone" column="phone" jdbcType="VARCHAR"/>
        <result property="sex" column="sex" jdbcType="INTEGER"/>
        <result property="avatar" column="avatar" jdbcType="VARCHAR"/>
        <result property="isdoctor" column="isdoctor" jdbcType="INTEGER"/>
        <result property="istherapist" column="istherapist" jdbcType="INTEGER"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!--查询用户信息，所属部门，所属角色-->
    <select id="selectUserList" resultType="hashmap">
        select
            U.id, U.status, U.username, U.nickname, U.realname, U.phone, U.sex,
            DATE_FORMAT(U.create_time, '%Y-%m-%d %T') create_time,
            D.id department_id, D.dname department_name, D.descrip department_desc,
            R.id role_id, R.rolename rolename, R.descrip role_desc
        from
            hs_user U
            left join hs_user_department X on X.user_id = U.id
            left join hs_department D on X.department_id = D.id
            left join hs_user_role Y on Y.user_id = U.id
            left join hs_role R on Y.role_id = R.id
        <where>
            U.customer_id = #{customerId}
            <if test="departmentId != null and departmentId != 0">
                and D.id = #{departmentId}
            </if>
            <if test="roleId != null and roleId != 0">
                and R.id = #{roleId}
            </if>
            <if test="status != null">
                and U.status = #{status}
            </if>
            <if test="term != null and term != ''">
                and (U.username like concat(concat('%',#{term}),'%')
                    or U.nickname like concat(concat('%',#{term}),'%')
                    or U.realname like concat(concat('%',#{term}),'%')
                    or U.phone like concat(concat('%',#{term}),'%'))
            </if>
            <if test="isdoctor != null">
                and U.isdoctor = #{isdoctor}
            </if>
            <if test="istherapist != null">
                and U.istherapist = #{istherapist}
            </if>
        </where>
    </select>

    <select id="selectUser" resultType="hashmap">
        select
            U.id, U.customer_id, U.status, U.username, U.nickname, U.realname, U.phone, U.sex, U.avatar, U.isdoctor, U.istherapist,
            DATE_FORMAT(U.create_time, '%Y-%m-%d %T') create_time,
            C.name customerName,
            D.id department_id, D.dname department_name, D.descrip department_desc,
            R.id role_id, R.rolename role_name, R.descrip role_desc
        from
            hs_user U
            left join ms_customer C on U.customer_id = C.id
            left join hs_user_department X on X.user_id = U.id
            left join hs_department D on X.department_id = D.id
            left join hs_user_role Y on Y.user_id = U.id
            left join hs_role R on Y.role_id = R.id
        where
            U.id = #{id}
    </select>

    <!--查询管理员信息-->
    <select id="selectAdmin" resultMap="UserMap">
        select
            U.*
        from
            hs_user U
            join hs_user_role X on X.user_id = U.id
            join hs_role R on X.role_id = R.id
        where
            U.customer_id = #{customerId}
            and R.customer_id = 0
        limit 1
    </select>

</mapper>
